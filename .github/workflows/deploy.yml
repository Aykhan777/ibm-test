name: CI/CD Flask App to IBM Kubernetes

on:
  push:
    branches:
      - main

env:
  REGISTRY: us.icr.io
  NAMESPACE: aykhan777123
  APP_NAME: flask-app
  K8S_CLUSTER: your-cluster-name
  IBM_REGION: us-south

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up IBM Cloud CLI
      uses: IBM/cloud-actions/setup-ibmcloud@v1
      with:
        ibmcloud_api_key: ${{ secrets.IBM_CLOUD_API_KEY }}
        region: ${{ env.IBM_REGION }}

    - name: Login to IBM Container Registry
      run: |
        ibmcloud cr login

    - name: Build and push Docker image
      run: |
        IMAGE_TAG=${GITHUB_SHA::8}  # unique tag from commit SHA
        docker build -t ${REGISTRY}/${NAMESPACE}/flask-demo:$IMAGE_TAG .
        docker push ${REGISTRY}/${NAMESPACE}/flask-demo:$IMAGE_TAG

    - name: Target IKS cluster
      run: |
        ibmcloud ks cluster config --cluster ${{ env.K8S_CLUSTER }}

    - name: Update Kubernetes deployment
      run: |
        kubectl set image deployment/${APP_NAME} ${APP_NAME}=${REGISTRY}/${NAMESPACE}/flask-demo:$IMAGE_TAG
        kubectl rollout status deployment/${APP_NAME}

